<!DOCTYPE HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>GameBoy Advance</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="mobile.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script>
  $(document).ready(function () {
    var inflight = false;

    // List ROMs
    $.ajax({
      method: 'POST',
      url: 'server.php',
      data: {
        request: 'listRoms'
      }
    })
    .done(function(msg) {
      var roms = JSON.parse(msg);

      var selections = $('#selections').html('');
      roms.forEach(function (rom) { 
        selections.append('<li>' + rom.substr(0, rom.length - 4) + '</li>');
      });

      // Rom selected
      $('#selections li').click(function () {
        if (inflight) return;
        var romName = $(this).text();

        // Get saves
        $.ajax({
          method: 'POST',
          url: 'server.php',
          data: {
            request: 'listSaves',
            gameName: romName
          }
        })
        .done(function(msg) {
          var saves = JSON.parse(msg);

          if (saves.length == 0) {
            goto_gba(romName);
          } else {
            // Display saves
            $.when(
              $('#selections li').slideUp()
            )
            .done(function() {
              inflight = false;
              selections = $('#selections').html('');

              $('#select-game').prepend('<div class="note">choose a save</div>');

              // Add new game option
              $('<li style="display:none;" class="bold" data-savename="{{new_game}}">New Game</li>')
                .appendTo(selections);

              saves.forEach(function (save) { 
                var new_li = '<li style="display:none;" data-savename="' + save +
                  '">' + save + '</li>';

                $(new_li).appendTo(selections);
              });

              $('#selections li, #select-game .note').slideDown();
              $('#select-game').animate({
                bottom: '+=45'
              });

              $('#selections li').click(function () {
                if (inflight) return;

                // New game
                if ($(this).attr('data-savename') === '{{new_game}}') {
                  return goto_gba(romName);
                }
                goto_gba(romName, $(this).attr('data-savename'));                
              });
            });
          }
        });
      });
    });

    // Rom search filter
    $('#search').on('change keyup paste', function () {
      var searchterm = $(this).val().toLowerCase();
      $('ul').children(':not(.bold)').each(function () {
        var hide = $(this).text().toLowerCase().indexOf(searchterm) < 0;
        $(this).toggleClass('hidden', hide);
      });
    });
  });

  var goto_gba = function (rom, save) {
    var url = 'gba.html?rom=' + rom;
    if (save) url += '&save=' + save;

    $('<div class="cover" id="cover-light"></div>')
      .appendTo('body')
      .fadeIn('fast', function () {
        window.location = url;
      });
  }
  </script>
</head>
<body>
  <div id="container">
    <header>
      <h1>GameBoy Advance</h1>
    </header>
    <div id="select-game">
      <input type="text" id="search" placeholder="Search" />
      <ul id="selections">
        <li>Loading ROMs...</li>
      </ul>
    </div>
    <footer>
    <p>Ajay Gandhi <a href="http://ajay-gandhi.com">ajay-gandhi.com</a></p>
    </footer>
  </div>
</body>
</html>
