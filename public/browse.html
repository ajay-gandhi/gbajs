<!DOCTYPE HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>GBA Play | Browse Games</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/game.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="js/login.js"></script>
  <script>
  var inflight = false;
  $(document).on('fully_ready', function () {

    // List ROMs
    $.ajax({
      url: 'listRoms'
    })
    .done(function(roms) {
      var selections = $('#selections').html('');
      roms.forEach(function (rom) { 
        selections.append('<li>' + rom.substr(0, rom.length - 4) + '</li>');
      });

      // Rom selected
      $('#selections li').click(function () {
        if (inflight) return;
        var romName = $(this).text();

        // Get saves
        var local_saves = list_local_saves(romName);
        $.ajax({
          url: 'listSaves',
          data: { rom_name: romName }
        })
        .done(function(saves) {
          // No saves
          return;
          if (saves.length == 0 && local_saves.length == 0) {
            goto_gba(romName);
            return;
          }

          // Display saves
          $.when(
            $('#selections li').slideUp()
          )
          .done(function() {
            inflight = false;
            selections = $('#selections').html('');

            $('#select-game').prepend('<div class="note">choose a save</div>');

            // Add new game option
            $('<li style="display:none;" class="bold" data-savename="{{new_game}}">New Game</li>')
              .appendTo(selections);

            local_saves.forEach(function (save) { 
              var new_li = '<li style="display:none;" data-local="true" ' +
                'data-savename="' + save + '"><span>Local </span>' + save + '</li>';

              $(new_li).appendTo(selections);
            });

            saves.forEach(function (save) { 
              var new_li = '<li style="display:none;" data-local="false" ' +
                'data-savename="' + save + '">' + save + '</li>';

              $(new_li).appendTo(selections);
            });

            $('#selections li, #select-game .note').slideDown();
            $('#select-game').animate({
              bottom: '+=45'
            });

            $('#selections li').click(function () {
              if (inflight) return;

              // New game
              if ($(this).attr('data-savename') === '{{new_game}}') {
                return goto_gba(romName);
              }
              var is_local = $(this).attr('data-local') === 'true';
              goto_gba(romName, $(this).attr('data-savename'), is_local);                
            });
          });
        });
      });
    });

    // Rom search filter
    $('#search').on('change keyup paste', function () {
      var searchterm = $(this).val().toLowerCase();
      $('ul').children(':not(.bold)').each(function () {
        var hide = $(this).text().toLowerCase().indexOf(searchterm) < 0;
        $(this).toggleClass('hidden', hide);
      });
    });
  });

  /**
   * Fades to white, then redirects
   */
  var goto_gba = function (rom, save, local) {
    var url = 'gba.html?rom=' + rom;
    if (save) url += '&save=' + save + '&local=' + local;

    $('<div class="cover" id="cover-light"></div>')
      .appendTo('body')
      .fadeIn('fast', function () {
        window.location = url;
      });
  }

  /**
   * Gets list of games from localStorage
   */
  var list_local_saves = function (rom) {
    rom = encodeURIComponent(rom);
    try {
      var storage = window.localStorage;
      var key = 'com.ajay-gandhi.gbajs.save';
      if (!storage[key]) return [];

      var parsed_storage = JSON.parse(storage[key]);
      if (!parsed_storage[rom]) return [];

      return Object.keys(parsed_storage[rom]);
    } catch (e) {
      return [];
    }
  }
  </script>
</head>
<body>
  <div id="container">
    <header>
      <h1>GameBoy Advance</h1>
    </header>
    <div id="select-game">
      <input type="text" id="search" placeholder="Search" />
      <ul id="selections">
        <li>Loading ROMs...</li>
      </ul>
    </div>
    <footer>
    <p>Ajay Gandhi <a href="http://ajay-gandhi.com">ajay-gandhi.com</a></p>
    </footer>
  </div>
</body>
</html>
